<html class="no-js fontawesome-i2svg-active fontawesome-i2svg-complete" lang="en">
<head>
    <!-- Global site tag (gtag.js) - Google Analytics -->

<script async src="https://www.googletagmanager.com/gtag/js?id=UA-131245045-1"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-131245045-1');
</script>

<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">


<meta property="og:site_name" content="Alexander's deveopment">
<meta property="og:type" content="website">

<!-- Styles -->
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="shortcut icon" href="/assets/images/common/favicon.png">
<link href="https://fonts.googleapis.com/css?family=Stylish&amp;subset=korean" rel="stylesheet">
<link href="/assets/built/static/page.css" rel="stylesheet">

<!-- Custom Styles -->
<style></style>

<script src="/assets/built/static/page.js"></script>


<!-- Analytics Code -->


<!-- Extra Header JS Code -->
    <!-- Page Info -->
    <title>Prometheus & Grafana (시스템 모니터링)</title>
    <meta name="description" content="Prometheus와 Grafana를 이용한 서버를 모니터링 방법">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Prometheus & Grafana (시스템 모니터링)">
    <meta name="twitter:description" content="Prometheus와 Grafana를 이용한 서버를 모니터링 방법">
    <meta name="twitter:image:src" content="">

    <!-- Facebook OpenGraph -->
    <meta property="og:title" content="Prometheus & Grafana (시스템 모니터링)">
    <meta property="og:description" content="Prometheus와 Grafana를 이용한 서버를 모니터링 방법">
    <meta property="og:image" content="">

    <meta property="og:url" content="https://alexonepath.github.io/category/etc/container-2-monitoring.html">
    <meta property="og:description" content="Prometheus와 Grafana를 이용한 서버를 모니터링 방법">
</head>
<body class="ajax-loading" data-site-url="" data-page-url="/">
<header class="header">
    <div class="header-image header-image--on"></div>
    <div class="header-image header-image--on"></div>
    <div class="header-image header-image--on"></div>
    <div class="header-image"></div>
    <div class="header-overlay"></div>

    <div class="header__content">
        <a href="/" class="header__title cc-active active-link">
            <img src="/assets/images/common/logo.png"/>
        </a>
        <p class="header__tagline">기술 블로그</p>

        <div class="menu">
            <div class="menu__toggle js-menu-toggle">
                <div class="menu__toggle__icon"><span></span></div>
            </div>
            <div class="menu__wrap">

                <script>
    let postMap = {}
    let categoryName = '';
</script>

    
        <script>
            categoryName = 'etc';
            if (postMap.hasOwnProperty(categoryName)) {
                postMap[categoryName] += 1;
            } else {
                postMap[categoryName] = 1;
            }
        </script>
    

    
        <script>
            categoryName = 'etc';
            if (postMap.hasOwnProperty(categoryName)) {
                postMap[categoryName] += 1;
            } else {
                postMap[categoryName] = 1;
            }
        </script>
    

    
        <script>
            categoryName = 'docker';
            if (postMap.hasOwnProperty(categoryName)) {
                postMap[categoryName] += 1;
            } else {
                postMap[categoryName] = 1;
            }
        </script>
    
        <script>
            categoryName = 'container';
            if (postMap.hasOwnProperty(categoryName)) {
                postMap[categoryName] += 1;
            } else {
                postMap[categoryName] = 1;
            }
        </script>
    

    
        <script>
            categoryName = 'docker';
            if (postMap.hasOwnProperty(categoryName)) {
                postMap[categoryName] += 1;
            } else {
                postMap[categoryName] = 1;
            }
        </script>
    
        <script>
            categoryName = 'guide';
            if (postMap.hasOwnProperty(categoryName)) {
                postMap[categoryName] += 1;
            } else {
                postMap[categoryName] = 1;
            }
        </script>
    

    
        <script>
            categoryName = 'docker';
            if (postMap.hasOwnProperty(categoryName)) {
                postMap[categoryName] += 1;
            } else {
                postMap[categoryName] = 1;
            }
        </script>
    
        <script>
            categoryName = 'guide';
            if (postMap.hasOwnProperty(categoryName)) {
                postMap[categoryName] += 1;
            } else {
                postMap[categoryName] = 1;
            }
        </script>
    

    
        <script>
            categoryName = 'docker';
            if (postMap.hasOwnProperty(categoryName)) {
                postMap[categoryName] += 1;
            } else {
                postMap[categoryName] = 1;
            }
        </script>
    
        <script>
            categoryName = 'container';
            if (postMap.hasOwnProperty(categoryName)) {
                postMap[categoryName] += 1;
            } else {
                postMap[categoryName] = 1;
            }
        </script>
    

    
        <script>
            categoryName = 'etc';
            if (postMap.hasOwnProperty(categoryName)) {
                postMap[categoryName] += 1;
            } else {
                postMap[categoryName] = 1;
            }
        </script>
    

    
        <script>
            categoryName = 'docker';
            if (postMap.hasOwnProperty(categoryName)) {
                postMap[categoryName] += 1;
            } else {
                postMap[categoryName] = 1;
            }
        </script>
    
        <script>
            categoryName = 'guide';
            if (postMap.hasOwnProperty(categoryName)) {
                postMap[categoryName] += 1;
            } else {
                postMap[categoryName] = 1;
            }
        </script>
    

    
        <script>
            categoryName = 'githubpage';
            if (postMap.hasOwnProperty(categoryName)) {
                postMap[categoryName] += 1;
            } else {
                postMap[categoryName] = 1;
            }
        </script>
    
        <script>
            categoryName = 'jekyll';
            if (postMap.hasOwnProperty(categoryName)) {
                postMap[categoryName] += 1;
            } else {
                postMap[categoryName] = 1;
            }
        </script>
    

    
        <script>
            categoryName = 'githubpage';
            if (postMap.hasOwnProperty(categoryName)) {
                postMap[categoryName] += 1;
            } else {
                postMap[categoryName] = 1;
            }
        </script>
    
        <script>
            categoryName = 'jekyll';
            if (postMap.hasOwnProperty(categoryName)) {
                postMap[categoryName] += 1;
            } else {
                postMap[categoryName] = 1;
            }
        </script>
    

    
        <script>
            categoryName = 'githubpage';
            if (postMap.hasOwnProperty(categoryName)) {
                postMap[categoryName] += 1;
            } else {
                postMap[categoryName] = 1;
            }
        </script>
    
        <script>
            categoryName = 'jekyll';
            if (postMap.hasOwnProperty(categoryName)) {
                postMap[categoryName] += 1;
            } else {
                postMap[categoryName] = 1;
            }
        </script>
    


<ul class="menu__list menu-list accordion">


    
        
    
        
    
        
    

    
    
    
    
    <li id="menu4" class="toggle menu__list__item accordion-toggle" path="/category/githubpage/">
        <span class="icon-plus"></span>
        <a class="menu-link" href="#">Github Page <script>if(postMap['githubpage'] != undefined){document.write('('+postMap['githubpage']+')');}</script></a>
    </li>
    
        <ul class="menu-submenu accordion-content">
            
                <li><a class="head menu__list__item" href="/category/githubpage/jekyll/">jekyll <script>if(postMap['jekyll'] != undefined){document.write('('+postMap['jekyll']+')');}</script></a></li>
            
        </ul>
    

    

    
    
    
    
    <li id="menu5" class="toggle menu__list__item accordion-toggle" path="/category/docker/">
        <span class="icon-plus"></span>
        <a class="menu-link" href="#">Docker <script>if(postMap['docker'] != undefined){document.write('('+postMap['docker']+')');}</script></a>
    </li>
    
        <ul class="menu-submenu accordion-content">
            
                <li><a class="head menu__list__item" href="/category/docker/guide/">guide <script>if(postMap['guide'] != undefined){document.write('('+postMap['guide']+')');}</script></a></li>
            
                <li><a class="head menu__list__item" href="/category/docker/container/">container <script>if(postMap['container'] != undefined){document.write('('+postMap['container']+')');}</script></a></li>
            
        </ul>
    

    

    
    
    
    
    <li id="menu6" class="toggle menu__list__item " path="/category/etc/">
        <span class=""></span>
        <a class="menu-link" href="/category/etc/">이모저모 <script>if(postMap['etc'] != undefined){document.write('('+postMap['etc']+')');}</script></a>
    </li>
    

</ul>

                <ul class="socials">
                    <li class="socials__item">
                        <a href="https://www.facebook.com/alexonepath" target="_blank" class="socials__item__link" title="Facebook">
                            <svg class="svg-inline--fa fa-facebook-f fa-w-9" aria-hidden="true" data-prefix="fab" data-icon="facebook-f" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 264 512" data-fa-i2svg="">
                                <path fill="currentColor" d="M76.7 512V283H0v-91h76.7v-71.7C76.7 42.4 124.3 0 193.8 0c33.3 0 61.9 2.5 70.2 3.6V85h-48.2c-37.8 0-45.1 18-45.1 44.3V192H256l-11.7 91h-73.6v229"></path>
                            </svg><!-- <i class="fab fa-facebook-f" aria-hidden="true"></i> -->
                        </a>
                    </li>


                    <li class="socials__item">
                        <a href="https://twitter.com/alexonepath" target="_blank" class="socials__item__link" title="Twitter">
                            <svg class="svg-inline--fa fa-twitter fa-w-16" aria-hidden="true" data-prefix="fab" data-icon="twitter" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" data-fa-i2svg="">
                                <path fill="currentColor" d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"></path>
                            </svg>
                        </a>
                    </li>


                    <li class="socials__item">
                        <a href="http://instagram.com/alexonepath" target="_blank" class="socials__item__link" title="Instagram">
                            <svg class="svg-inline--fa fa-instagram fa-w-14" aria-hidden="true" data-prefix="fab" data-icon="instagram" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" data-fa-i2svg="">
                                <path fill="currentColor" d="M224.1 141c-63.6 0-114.9 51.3-114.9 114.9s51.3 114.9 114.9 114.9S339 319.5 339 255.9 287.7 141 224.1 141zm0 189.6c-41.1 0-74.7-33.5-74.7-74.7s33.5-74.7 74.7-74.7 74.7 33.5 74.7 74.7-33.6 74.7-74.7 74.7zm146.4-194.3c0 14.9-12 26.8-26.8 26.8-14.9 0-26.8-12-26.8-26.8s12-26.8 26.8-26.8 26.8 12 26.8 26.8zm76.1 27.2c-1.7-35.9-9.9-67.7-36.2-93.9-26.2-26.2-58-34.4-93.9-36.2-37-2.1-147.9-2.1-184.9 0-35.8 1.7-67.6 9.9-93.9 36.1s-34.4 58-36.2 93.9c-2.1 37-2.1 147.9 0 184.9 1.7 35.9 9.9 67.7 36.2 93.9s58 34.4 93.9 36.2c37 2.1 147.9 2.1 184.9 0 35.9-1.7 67.7-9.9 93.9-36.2 26.2-26.2 34.4-58 36.2-93.9 2.1-37 2.1-147.8 0-184.8zM398.8 388c-7.8 19.6-22.9 34.7-42.6 42.6-29.5 11.7-99.5 9-132.1 9s-102.7 2.6-132.1-9c-19.6-7.8-34.7-22.9-42.6-42.6-11.7-29.5-9-99.5-9-132.1s-2.6-102.7 9-132.1c7.8-19.6 22.9-34.7 42.6-42.6 29.5-11.7 99.5-9 132.1-9s102.7-2.6 132.1 9c19.6 7.8 34.7 22.9 42.6 42.6 11.7 29.5 9 99.5 9 132.1s2.7 102.7-9 132.1z"></path>
                            </svg>
                        </a>
                    </li>

                    <li class="socials__item">
                        <a href="mailto:alexonepath@gmail.com" target="_blank" class="socials__item__link" title="Instagram">
                            <svg version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="-3 -3 20 20" style="enable-background:new 0 0 14 14;" xml:space="preserve">
                                <path style="fill:#030104;" d="M7,9L5.268,7.484l-4.952,4.245C0.496,11.896,0.739,12,1.007,12h11.986c0.267,0,0.509-0.104,0.688-0.271L8.732,7.484L7,9z"/>
                                <path style="fill:#030104;" d="M13.684,2.271C13.504,2.103,13.262,2,12.993,2H1.007C0.74,2,0.498,2.104,0.318,2.273L7,8L13.684,2.271z"/>
                                <polygon style="fill:#030104;" points="0,2.878 0,11.186 4.833,7.079"/>
                                <polygon style="fill:#030104;" points="9.167,7.079 14,11.186 14,2.875"/>
                            </svg>
                        </a>
                    </li>

                    <!--
                    <li class="socials__item">
                        <a href="http://tumblr.com" target="_blank" class="socials__item__link" title="Tumblr">
                            <svg class="svg-inline--fa fa-tumblr fa-w-10" aria-hidden="true" data-prefix="fab" data-icon="tumblr" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512" data-fa-i2svg="">
                                <path fill="currentColor" d="M309.8 480.3c-13.6 14.5-50 31.7-97.4 31.7-120.8 0-147-88.8-147-140.6v-144H17.9c-5.5 0-10-4.5-10-10v-68c0-7.2 4.5-13.6 11.3-16 62-21.8 81.5-76 84.3-117.1.8-11 6.5-16.3 16.1-16.3h70.9c5.5 0 10 4.5 10 10v115.2h83c5.5 0 10 4.4 10 9.9v81.7c0 5.5-4.5 10-10 10h-83.4V360c0 34.2 23.7 53.6 68 35.8 4.8-1.9 9-3.2 12.7-2.2 3.5.9 5.8 3.4 7.4 7.9l22 64.3c1.8 5 3.3 10.6-.4 14.5z"></path>
                            </svg>
                        </a>
                    </li>


                    <li class="socials__item">
                        <a href="http://dribbble.com" target="_blank" class="socials__item__link" title="Dribbble">
                            <svg class="svg-inline--fa fa-dribbble fa-w-16" aria-hidden="true" data-prefix="fab" data-icon="dribbble" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" data-fa-i2svg="">
                                <path fill="currentColor" d="M256 8C119.252 8 8 119.252 8 256s111.252 248 248 248 248-111.252 248-248S392.748 8 256 8zm163.97 114.366c29.503 36.046 47.369 81.957 47.835 131.955-6.984-1.477-77.018-15.682-147.502-6.818-5.752-14.041-11.181-26.393-18.617-41.614 78.321-31.977 113.818-77.482 118.284-83.523zM396.421 97.87c-3.81 5.427-35.697 48.286-111.021 76.519-34.712-63.776-73.185-116.168-79.04-124.008 67.176-16.193 137.966 1.27 190.061 47.489zm-230.48-33.25c5.585 7.659 43.438 60.116 78.537 122.509-99.087 26.313-186.36 25.934-195.834 25.809C62.38 147.205 106.678 92.573 165.941 64.62zM44.17 256.323c0-2.166.043-4.322.108-6.473 9.268.19 111.92 1.513 217.706-30.146 6.064 11.868 11.857 23.915 17.174 35.949-76.599 21.575-146.194 83.527-180.531 142.306C64.794 360.405 44.17 310.73 44.17 256.323zm81.807 167.113c22.127-45.233 82.178-103.622 167.579-132.756 29.74 77.283 42.039 142.053 45.189 160.638-68.112 29.013-150.015 21.053-212.768-27.882zm248.38 8.489c-2.171-12.886-13.446-74.897-41.152-151.033 66.38-10.626 124.7 6.768 131.947 9.055-9.442 58.941-43.273 109.844-90.795 141.978z"></path>
                            </svg>
                        </a>
                    </li>
                    -->
                </ul>
            </div>
        </div>

    </div>

</header>
<div class="page">
    <div class="page__content" data-page-title="Prometheus & Grafana (시스템 모니터링)">
        <section class="intro">
            <div class="wrap">
                <h1>Prometheus & Grafana (시스템 모니터링)</h1>
                <p>Jan 11, 2019</p>
            </div>
        </section>

        <section class="single post-content alex-content" style="visibility:hidden">
            <div class="wrap">
                <blockquote>
  <p>Prometheus &amp; Grafana 란?</p>
  <ul>
    <li><a href="https://prometheus.io/" target="_blank">Prometheus</a>
      <ul>
        <li>시스템을 모니터링 하고, 설정한 임계치를 넘으면 알람을 발송해주는 오픈소스프로젝트이다.</li>
        <li>다른 모니터링 시스템과 달리 수집하고자 하는 노드들이 서버로 데이터를 전달하는 방식이 아닌</li>
        <li>서버가 각노드에 데이터를 요청한다. (pull 방식)</li>
        <li>모니터링대상 서버들을 정적으로 yml 파일에 설정하지 않고 동적으로 할 수도 있음.</li>
      </ul>
    </li>
    <li><a href="https://grafana.com/" target="_blank">Grafana</a>
      <ul>
        <li>측정항목에 대해 쿼리, 시각화, 경고메시지 등을 할 수 있다.</li>
      </ul>
    </li>
  </ul>
</blockquote>

<h3 id="prometheus-컴포넌트">Prometheus 컴포넌트</h3>
<ul>
  <li>Server : 각 클라이언트로부터 시스템 정보를 수집하고 시계열 데이터를 저장</li>
  <li>Exporter : Server에서 데이터를 수집하기 위한 Client (모니터링 대상 서버에서 실행)</li>
  <li>그외 Push Gateway, Alert Manager 등등의 다양한 툴들이 있음</li>
</ul>

<h3 id="prometheus-및-grafana-실행">Prometheus 및 Grafana 실행</h3>
<blockquote>
  <p>아래의 prometheus.yml 파일과 prometheus.sh 파일을 같은 디렉토리에 준비<br />
prometheus.sh 스크립트를 실행하면 해당 노드에는 server 및 grafana 컨테이너를 실행하고<br />
리모트 서버들에는 exporter 컨테이너들을 실행해 준다.</p>
</blockquote>

<p><strong>사전작업</strong></p>
<ul>
  <li>스크립트를 실행하는 노드에서 ssh로 리모트 서버에 접속가능 하도록 해당 사용자의 public key 등록</li>
  <li>~/.ssh/id_rsa.pub의 값을 리모트 서버의 ~/.ssh/authorized_keys에 등록한다.</li>
</ul>

<p><strong>Prometheus server 설정파일 (prometheus.yml)</strong></p>
<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># my global config</span>
<span class="na">global</span><span class="pi">:</span>
  <span class="na">scrape_interval</span><span class="pi">:</span>     <span class="s">5s</span> <span class="c1"># Set the scrape interval to every 15 seconds. Default is every 1 minute.</span>
  <span class="na">evaluation_interval</span><span class="pi">:</span> <span class="s">15s</span> <span class="c1"># Evaluate rules every 15 seconds. The default is every 1 minute.</span>
  <span class="c1"># scrape_timeout is set to the global default (10s).</span>
  <span class="na">external_labels</span><span class="pi">:</span>
    <span class="na">alex</span><span class="pi">:</span> <span class="s1">'</span><span class="s">alexander'</span>

<span class="c1"># Alertmanager configuration</span>
<span class="na">alerting</span><span class="pi">:</span>
  <span class="na">alertmanagers</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">static_configs</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">targets</span><span class="pi">:</span>
      <span class="c1"># - alertmanager:9093</span>

<span class="c1"># Load rules once and periodically evaluate them according to the global 'evaluation_interval'.</span>
<span class="na">rule_files</span><span class="pi">:</span>
<span class="c1"># - "first_rules.yml"</span>
<span class="c1"># - "second_rules.yml"</span>

<span class="c1"># A scrape configuration containing exactly one endpoint to scrape:</span>
<span class="c1"># Here it's Prometheus itself.</span>
<span class="na">scrape_configs</span><span class="pi">:</span>
<span class="c1"># The job name is added as a label `job=&lt;job_name&gt;` to any timeseries scraped from this config.</span>
  <span class="pi">-</span> <span class="na">job_name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">alex'</span>
    <span class="na">scrape_interval</span><span class="pi">:</span> <span class="s">5s</span>
    <span class="na">static_configs</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">targets</span><span class="pi">:</span> <span class="pi">[</span><span class="s1">'</span><span class="s">localhost:9090'</span><span class="pi">,</span><span class="s1">'</span><span class="s">expoter_ip:port'</span><span class="pi">]</span> <span class="c1"># 모니터링 대상이 되는 서버정보 추가</span>
</code></pre></div></div>

<p><strong>실행스크립트 (prometheus.sh)</strong></p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>

<span class="nv">Green</span><span class="o">=</span><span class="s1">'\033[0;32m'</span>
<span class="nv">Yellow</span><span class="o">=</span><span class="s1">'\033[1;33m'</span>
<span class="nv">RED</span><span class="o">=</span><span class="s1">'\033[031m'</span>
<span class="nv">NC</span><span class="o">=</span><span class="s1">'\033[0m'</span>

<span class="c"># 컨테이너 이름</span>
<span class="nv">PROMETHEUS_SERVER_CONTAINER_NAME</span><span class="o">=</span><span class="s2">"prometheus-server"</span>
<span class="nv">PROMETHEUS_EXPORTER_CONTAINER_NAME</span><span class="o">=</span><span class="s2">"prometheus-exporter"</span>
<span class="nv">PROMETHEUS_GRAFANA_CONTAINER_NAME</span><span class="o">=</span><span class="s2">"prometheus-grafana"</span>

<span class="c"># 컨테이너에 매핑될 호스트 디렉토리</span>
<span class="nv">ROOT_DIR</span><span class="o">=</span>/data/repositories/docker-repository
<span class="nv">PROMETHEUS_SERVER_DIR</span><span class="o">=</span><span class="k">${</span><span class="nv">ROOT_DIR</span><span class="k">}</span>/prometheus-server
<span class="nv">PROMETHEUS_EXPORTER_DIR</span><span class="o">=</span><span class="k">${</span><span class="nv">ROOT_DIR</span><span class="k">}</span>/prometheus-exporter
<span class="nv">PROMETHEUS_GRAFANA_DIR</span><span class="o">=</span><span class="k">${</span><span class="nv">ROOT_DIR</span><span class="k">}</span>/prometheus-grafana

<span class="c"># 컨테이너에 매핑될 호스트 포트</span>
<span class="nv">PROMETHEUS_SERVER_PORT</span><span class="o">=</span>30001
<span class="nv">PROMETHEUS_GRAFANA_PORT</span><span class="o">=</span>30000
<span class="c"># Grafana admin 비번</span>
<span class="nv">PROMETHEUS_GRAFANA_ADMIN_PWD</span><span class="o">=</span>admin!

<span class="c"># exporter가 설치될 노드 정보</span>
<span class="nv">REMOTE_USER</span><span class="o">=</span><span class="s2">"soul"</span>
<span class="c"># ("server_ip1@컨네이너에 매핑될 포트" "server_ip2@컨네이너에 매핑될 포트")</span>
<span class="nv">REMOTE_LIST</span><span class="o">=(</span><span class="s2">"remote-ip@port"</span><span class="o">)</span>

runRemote<span class="o">(){</span>
    <span class="nv">IDX</span><span class="o">=</span>0
    <span class="k">for </span>remote <span class="k">in</span> <span class="s2">"</span><span class="k">${</span><span class="nv">REMOTE_LIST</span><span class="p">[@]</span><span class="k">}</span><span class="s2">"</span>
    <span class="k">do
        </span><span class="nv">IDX</span><span class="o">=</span><span class="k">$((</span>IDX+1<span class="k">))</span>

        <span class="nv">IP_PORT</span><span class="o">=(</span><span class="k">${</span><span class="nv">remote</span><span class="p">//@/ </span><span class="k">}</span><span class="o">)</span>
        <span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"</span><span class="k">${</span><span class="nv">Green</span><span class="k">}</span><span class="s2">Run remote (</span><span class="k">${</span><span class="nv">IDX</span><span class="k">}</span><span class="s2">/</span><span class="k">${#</span><span class="nv">REMOTE_LIST</span><span class="p">[@]</span><span class="k">}</span><span class="s2">)</span><span class="k">${</span><span class="nv">NC</span><span class="k">}</span><span class="s2">"</span>

        ssh <span class="nt">-o</span> <span class="s2">"StrictHostKeyChecking no"</span> <span class="k">${</span><span class="nv">REMOTE_USER</span><span class="k">}</span>@<span class="k">${</span><span class="nv">IP_PORT</span><span class="p">[0]</span><span class="k">}</span> docker rm <span class="nt">-f</span> <span class="k">${</span><span class="nv">PROMETHEUS_EXPORTER_CONTAINER_NAME</span><span class="k">}</span>
        ssh <span class="nt">-o</span> <span class="s2">"StrictHostKeyChecking no"</span> <span class="k">${</span><span class="nv">REMOTE_USER</span><span class="k">}</span>@<span class="k">${</span><span class="nv">IP_PORT</span><span class="p">[0]</span><span class="k">}</span> <span class="nb">sudo </span>rm <span class="nt">-rf</span> <span class="k">${</span><span class="nv">PROMETHEUS_EXPORTER_DIR</span><span class="k">}</span>
        ssh <span class="nt">-o</span> <span class="s2">"StrictHostKeyChecking no"</span> <span class="k">${</span><span class="nv">REMOTE_USER</span><span class="k">}</span>@<span class="k">${</span><span class="nv">IP_PORT</span><span class="p">[0]</span><span class="k">}</span> <span class="nb">sudo </span>mkdir <span class="nt">-p</span> <span class="k">${</span><span class="nv">PROMETHEUS_EXPORTER_DIR</span><span class="k">}</span>
        ssh <span class="nt">-o</span> <span class="s2">"StrictHostKeyChecking no"</span> <span class="k">${</span><span class="nv">REMOTE_USER</span><span class="k">}</span>@<span class="k">${</span><span class="nv">IP_PORT</span><span class="p">[0]</span><span class="k">}</span> <span class="nb">sudo </span>chmod 777 <span class="k">${</span><span class="nv">PROMETHEUS_EXPORTER_DIR</span><span class="k">}</span>

        docker run <span class="nt">-d</span> <span class="nt">--name</span> <span class="k">${</span><span class="nv">PROMETHEUS_EXPORTER_CONTAINER_NAME</span><span class="k">}</span> <span class="se">\</span>
        <span class="nt">--restart</span><span class="o">=</span>always <span class="se">\</span>
        <span class="nt">-v</span> /etc/localtime:/etc/localtime:ro <span class="se">\</span>
        <span class="nt">-p</span> <span class="k">${</span><span class="nv">IP_PORT</span><span class="p">[1]</span><span class="k">}</span>:9100 <span class="se">\</span>
        prom/node-exporter

        <span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"</span><span class="k">${</span><span class="nv">Green</span><span class="k">}</span><span class="s2">Done. (</span><span class="k">${</span><span class="nv">IDX</span><span class="k">}</span><span class="s2">/</span><span class="k">${#</span><span class="nv">REMOTE_LIST</span><span class="p">[@]</span><span class="k">}</span><span class="s2">)</span><span class="k">${</span><span class="nv">NC</span><span class="k">}</span><span class="s2">"</span>
    <span class="k">done</span>
<span class="o">}</span>

runServer<span class="o">(){</span>
    <span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"</span><span class="k">${</span><span class="nv">Green</span><span class="k">}</span><span class="s2">Run server</span><span class="k">${</span><span class="nv">NC</span><span class="k">}</span><span class="s2">"</span>

    <span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"</span><span class="k">${</span><span class="nv">Yellow</span><span class="k">}</span><span class="s2">Clear</span><span class="k">${</span><span class="nv">NC</span><span class="k">}</span><span class="s2">"</span>
    <span class="c"># Clear prometheus server</span>
    docker rm <span class="nt">-f</span> <span class="k">${</span><span class="nv">PROMETHEUS_SERVER_CONTAINER_NAME</span><span class="k">}</span>
    <span class="nb">sudo </span>rm <span class="nt">-rf</span> <span class="k">${</span><span class="nv">PROMETHEUS_SERVER_DIR</span><span class="k">}</span>
    mkdir <span class="nt">-p</span> <span class="k">${</span><span class="nv">PROMETHEUS_SERVER_DIR</span><span class="k">}</span>
    chmod 777 <span class="k">${</span><span class="nv">PROMETHEUS_SERVER_DIR</span><span class="k">}</span>

    <span class="c"># Clear grafana</span>
    docker rm <span class="nt">-f</span> <span class="k">${</span><span class="nv">PROMETHEUS_GRAFANA_CONTAINER_NAME</span><span class="k">}</span>
    <span class="nb">sudo </span>rm <span class="nt">-rf</span> <span class="k">${</span><span class="nv">PROMETHEUS_GRAFANA_DIR</span><span class="k">}</span>
    mkdir <span class="nt">-p</span> <span class="k">${</span><span class="nv">PROMETHEUS_SERVER_DIR</span><span class="k">}</span>/conf
    cp prometheus.yml <span class="k">${</span><span class="nv">PROMETHEUS_SERVER_DIR</span><span class="k">}</span>/conf

    <span class="c"># Run prometheus-server (conf location : /etc/prometheus/prometheus.yml)</span>
    docker run <span class="nt">-d</span> <span class="nt">--name</span> <span class="k">${</span><span class="nv">PROMETHEUS_SERVER_CONTAINER_NAME</span><span class="k">}</span> <span class="se">\</span>
    <span class="nt">--restart</span><span class="o">=</span>always <span class="se">\</span>
    <span class="nt">-p</span> <span class="k">${</span><span class="nv">PROMETHEUS_SERVER_PORT</span><span class="k">}</span>:9090 <span class="se">\</span>
    <span class="nt">-v</span> /etc/localtime:/etc/localtime:ro <span class="se">\</span>
    <span class="nt">-v</span> <span class="k">${</span><span class="nv">PROMETHEUS_SERVER_DIR</span><span class="k">}</span>:/prometheus <span class="se">\</span>
    <span class="nt">-v</span> <span class="k">${</span><span class="nv">PROMETHEUS_SERVER_DIR</span><span class="k">}</span>/conf/prometheus.yml:/etc/prometheus/prometheus.yml <span class="se">\</span>
    prom/prometheus

    <span class="c"># Run grafana (conf location : /etc/grafana/grafana.ini)</span>
    docker run <span class="nt">-d</span> <span class="nt">--name</span> <span class="k">${</span><span class="nv">PROMETHEUS_GRAFANA_CONTAINER_NAME</span><span class="k">}</span> <span class="se">\</span>
    <span class="nt">--restart</span><span class="o">=</span>always <span class="se">\</span>
    <span class="nt">-u</span> <span class="k">$(</span>id <span class="nt">-u</span> root<span class="k">)</span>:<span class="k">$(</span>id <span class="nt">-g</span> root<span class="k">)</span> <span class="se">\</span>
    <span class="nt">-p</span> <span class="k">${</span><span class="nv">PROMETHEUS_GRAFANA_PORT</span><span class="k">}</span>:3000 <span class="se">\</span>
    <span class="nt">-v</span> /etc/localtime:/etc/localtime:ro <span class="se">\</span>
    <span class="nt">-v</span> <span class="k">${</span><span class="nv">PROMETHEUS_GRAFANA_DIR</span><span class="k">}</span>/data:/var/lib/grafana <span class="se">\</span>
    <span class="nt">-e</span> <span class="s2">"GF_SERVER_ROOT_URL=http://ip"</span> <span class="se">\</span>
    <span class="nt">-e</span> <span class="s2">"GF_SECURITY_ADMIN_PASSWORD=</span><span class="k">${</span><span class="nv">PROMETHEUS_GRAFANA_ADMIN_PWD</span><span class="k">}</span><span class="s2">"</span> <span class="se">\</span>
    <span class="nt">-e</span> <span class="s2">"GF_SMTP_SKIP_VERITY=true"</span> <span class="se">\</span>
    <span class="nt">-e</span> <span class="s2">"GF_INSTALL_PLUGINS=grafana-clock-panel,grafana-simple-json-datasource,grafana-piechart-panel"</span> <span class="se">\</span>
    grafana/grafana:5.4.2

    <span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"</span><span class="k">${</span><span class="nv">Green</span><span class="k">}</span><span class="s2">Done."</span>
<span class="o">}</span>

runRemote
<span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>
runServer
</code></pre></div></div>

<p><strong>서버접속</strong></p>
<ul>
  <li>Prometheus server : http://ip:30001 (위에서는 port를 30001로 주었음.)</li>
  <li>Grafana : http://ip:30000 (위에서는 port를 30000로 주었음.)</li>
</ul>

<h2 id="grafana-적용">Grafana 적용</h2>
<blockquote>
  <p>이제 Grafana를 이용하여 Prometheus에서 수집한 각 서버의 자원정보를 아름답게(?) 시각화하는 설정을 진행한다.</p>
</blockquote>

<p>1.Grafana 접속 &gt; Add data source 선택
<img src="/assets/images/post/docker/container/2019-01-11-container-2-monitoring/1.png" alt="1" width="600px" /></p>

<p>2.Prometheus 선택
<img src="/assets/images/post/docker/container/2019-01-11-container-2-monitoring/2.png" alt="1" width="600px" /></p>

<p>3.Data source 설정
<img src="/assets/images/post/docker/container/2019-01-11-container-2-monitoring/3.png" alt="1" width="600px" /></p>

<p>4.Dashboard 설정
<img src="/assets/images/post/docker/container/2019-01-11-container-2-monitoring/4.png" alt="1" width="600px" /></p>

<p>5.Panel 설정
<img src="/assets/images/post/docker/container/2019-01-11-container-2-monitoring/5.png" alt="1" width="800px" /></p>
<ul>
  <li>좌측의 Graph 선택</li>
  <li>우측 상단의 패널추가 버튼 클릭하여 총4개의 패널이 생성되도록 한다.</li>
  <li>패널은 드래그&amp;드롭으로 아래 그림과 같이 배치가능.</li>
</ul>

<p>6.패널 쿼리설정
<img src="/assets/images/post/docker/container/2019-01-11-container-2-monitoring/6.png" alt="1" width="800px" /></p>
<ul>
  <li>Panel Tile을 클릭하면 위와 같은 메뉴들이 나온다</li>
  <li>Edit 선택</li>
</ul>

<p>7.각 리소스 설정<br />
<strong>CPU</strong>
<img src="/assets/images/post/docker/container/2019-01-11-container-2-monitoring/cpu.png" alt="1" width="800px" /></p>
<ul>
  <li>Axes 탭 &gt; Unit &gt; none &gt; percent (0.0-1.0)</li>
  <li>Display 탭 &gt; Mode Options &gt; Line Width &gt; 2</li>
</ul>

<p><strong>Memory</strong>
<img src="/assets/images/post/docker/container/2019-01-11-container-2-monitoring/memory.png" alt="1" width="800px" /></p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># total</span>
node_memory_MemTotal_bytes<span class="o">{</span><span class="nv">job</span><span class="o">=</span><span class="s1">'alex'</span>,instance<span class="o">=</span><span class="s1">'remote-ip:30002'</span><span class="o">}</span>
<span class="c"># used</span>
node_memory_MemTotal_bytes<span class="o">{</span><span class="nv">job</span><span class="o">=</span><span class="s1">'alex'</span>,instance<span class="o">=</span><span class="s1">'remote-ip:30002'</span><span class="o">}</span> - node_memory_MemFree_bytes<span class="o">{</span><span class="nv">job</span><span class="o">=</span><span class="s1">'alex'</span>,instance<span class="o">=</span><span class="s1">'remote-ip:30002'</span><span class="o">}</span> - node_memory_Buffers_bytes<span class="o">{</span><span class="nv">job</span><span class="o">=</span><span class="s1">'alex'</span>,instance<span class="o">=</span><span class="s1">'remote-ip:30002'</span><span class="o">}</span> - node_memory_Cached_bytes<span class="o">{</span><span class="nv">job</span><span class="o">=</span><span class="s1">'alex'</span>,instance<span class="o">=</span><span class="s1">'remote-ip:30002'</span><span class="o">}</span>
<span class="c"># buff/cache</span>
node_memory_Buffers_bytes<span class="o">{</span><span class="nv">job</span><span class="o">=</span><span class="s1">'alex'</span>,instance<span class="o">=</span><span class="s1">'remote-ip:30002'</span><span class="o">}</span>+node_memory_Cached_bytes<span class="o">{</span><span class="nv">job</span><span class="o">=</span><span class="s1">'alex'</span>,instance<span class="o">=</span><span class="s1">'remote-ip:30002'</span><span class="o">}</span>
<span class="c"># free</span>
node_memory_MemFree_bytes<span class="o">{</span><span class="nv">job</span><span class="o">=</span><span class="s1">'alex'</span>,instance<span class="o">=</span><span class="s1">'remote-ip:30002'</span><span class="o">}</span>
</code></pre></div></div>
<ul>
  <li>Axes 탭 &gt; Unit &gt; data (Metric) &gt; bytes</li>
  <li>Display 탭 &gt; Mode Options &gt; Line Width &gt; 2</li>
</ul>

<p><strong>Disk</strong>
<img src="/assets/images/post/docker/container/2019-01-11-container-2-monitoring/disk.png" alt="1" width="800px" /></p>
<ul>
  <li>Axes 탭 &gt; Unit &gt; data (Metric) &gt; bytes</li>
  <li>Display 탭 &gt; Mode Options &gt; Line Width &gt; 2</li>
</ul>

<p><strong>Network</strong>
<img src="/assets/images/post/docker/container/2019-01-11-container-2-monitoring/network.png" alt="1" width="800px" /></p>
<ul>
  <li>Axes 탭 &gt; Unit &gt; data rate &gt; bytes/sec</li>
  <li>Display 탭 &gt; Mode Options &gt; Line Width &gt; 2</li>
</ul>

<p><strong>최종 설정된 모습</strong>
<img src="/assets/images/post/docker/container/2019-01-11-container-2-monitoring/done.png" alt="1" width="800px" /></p>


            </div>
            <div style="height: 100px"></div>
            
                <div id="disqus_thread"></div>
                <script>

                    /**
                     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
                     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
                    /*
                    var disqus_config = function () {
                    this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
                    this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
                    };
                    */
                    (function() { // DON'T EDIT BELOW THIS LINE
                        var d = document, s = d.createElement('script');
                        s.src = 'https://alexonepath-1.disqus.com/embed.js';
                        s.setAttribute('data-timestamp', +new Date());
                        (d.head || d.body).appendChild(s);
                    })();
                </script>
                <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
            
        </section>
    </div>
</div>
<footer class="footer">
    <div class="footer__copyright">
        <span>© Alexonepath.</span> All rights reserved. Powered by GitHub Pages.
    </div>
</footer>
</body>
</html>